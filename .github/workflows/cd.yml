name: CD

on:
  workflow_run:
    workflows:
      - "CI"
    types:
      - completed
    branches:
      - "**"

jobs:
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-22.04
    environment:
      name: dev
      url: http://dev.muse.kiryuxa.com
    steps:
      - name: Set up JDK 21 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21.0'

      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Log in to Docker Hub via token
        run: docker login -u myshx -p ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build Server Docker Image
        run: |
          ./tools/scripts/buildJar.sh
          docker build . -t "myshx/muse-server:dev-${{ github.sha }}"

      - name: Push Server Docker Image
        run: docker push "myshx/muse-server:dev-${{ github.sha }}"

      - name: Run server at home lab
        uses: appleboy/ssh-action@v1.0.3
        env:
          GIT_COMMIT_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          envs: GIT_COMMIT_SHA
          script: |
            export GIT_COMMIT_SHA=$GIT_COMMIT_SHA
            docker stop "muse-server:dev-$GIT_COMMIT_SHA"
            docker rm "muse-server:dev-$GIT_COMMIT_SHA"
            docker rmi "muse-server:dev-$GIT_COMMIT_SHA"
            docker run -d -p 50505:8080 "myshx/muse-server:dev-$GIT_COMMIT_SHA"
